%% Copyright 2014 Maïeul Rouquette
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Maïeul Rouquette
% This work consists of the files handout.sty and example and documentation files.

\ProvidesPackage{handout}[2014/03/18 1.0.0 Handout package]
\RequirePackage{kvoptions,etoolbox}

% Options
\DeclareBoolOption[false]{sectioning}
\ProcessKeyvalOptions*

% Warning tools
\newcommand{\handout@warning}[1]{\@latex@warning{Handout: #1}}

% Opening the handout file
\newwrite\@handout
\immediate\openout\@handout=\jobname.handout


% The main command
\newcommand{\handout}[1]{%	
	\input{#1}% Add the handout
	\immediate\write\@handout {\string\input{#1}}
}

% Output the sectionning commands in the .handout file

\ifhandout@sectioning%Only if needed by option
	
	\pretocmd{\@sect}{% 
		\immediate\write\@handout{\string\csuse{#1}{#8}}%
		}{}{\handout@warning{Can't patch sectioning commands}}

\fi
% Call the handout file at the end

\AtEndDocument{%
	\immediate\closeout\@handout%
	\before@handout%
	\ifdef{\beforehandout}{\beforehandout}{\handout@warning{No command defined to be run before handout}}
	\input\jobname.handout%
}

% Standard command before handout
\newcommand{\before@handout}{%
	% New page
	\newpage%
	% Reset counter
	\setcounter{page}{1}%
	\setcounter{footnote}{0}%
	\ifhandout@sectioning%
		\setcounter{section}{0}%
		\setcounter{subsection}{0}%
		\setcounter{subsubsection}{0}%
	\fi
	
	% Note new datas in content or in label or index
	\def\addcontentsline##1##2##3{}
	\let\label\@gobble
	\let\index\@gobble
}
